@using FitnessDuck.Client.Localization
@using FitnessDuck.Models.DTOs
@using FitnessDuck.Share.Clients.Implementations
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization

@inject IStringLocalizer<Localizations> _localizer
@inject LessonApiClient _lessons
@inject ISnackbar _snackbar



<MudCard Elevation="1" Class="mb-2 pa-2" Style="border-radius:8px;">
    <MudStack Spacing="1">
        <MudStack  AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Row>
            <MudText Typo="Typo.h6">@(_lesson.Schedule?.Name ?? _lesson.Name)</MudText>
            <MudStack Spacing="0">
                <MudText Typo="Typo.subtitle2" Align="Align.Right">@_lesson.StartDateUtc.ToShortTimeString()</MudText>
                <MudText Typo="Typo.caption" Align="Align.Right">@_lesson.EndDateUtc.ToShortTimeString()</MudText>
            </MudStack>
        </MudStack>

        <MudStack Spacing="1" AlignItems="AlignItems.Center" Row>
            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
            <MudText Typo="Typo.caption">@(_lesson.Trainer is not null ? _lesson.Trainer.GetFullName() : "-")</MudText>
        </MudStack>

        <MudText Typo="Typo.body2" Class="mb-1">@(_lesson.Description ?? "-")</MudText>

        <MudStack Spacing="4" AlignItems="AlignItems.Center" Row>
            <MudStack AlignItems="AlignItems.Center" Spacing="1"Row>
                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                <MudText Typo="Typo.caption">@_lesson.DurationMinutes() min.</MudText>
            </MudStack>
            <MudStack AlignItems="AlignItems.Center" Spacing="1" Row>
                <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" />
                <MudText Typo="Typo.caption">@_lesson.AvailableSeats() / @_lesson.Seats</MudText>
            </MudStack>
            <MudSpacer/>
            <AuthorizeView>
                <Authorized>
                @if (_lesson.IsUserRegistered(_userId))
                {
                    <MudIconButton Variant="Variant.Text" Color="Color.Error" Icon=@Icons.Material.Filled.DeleteForever OnClick="UnsubscribeFom"></MudIconButton>

                }
                else
                {
                    <MudIconButton Variant="Variant.Text" Color="Color.Success" Icon=@Icons.Material.Filled.AddCircle OnClick="SubscribeTo"></MudIconButton>
                }
                </Authorized>
            </AuthorizeView>
        </MudStack>
    </MudStack>
</MudCard>

@code {
    
    [Parameter] public LessonDto _lesson { get; set; } = new();
    [Parameter] public EventCallback OnSubscribe { get; set; } = new();
    [Parameter] public EventCallback OnUnSubscribe { get; set; } = new();
    [CascadingParameter] Task<AuthenticationState> authenticationStateTask { get; set; }
    
    
    private Guid _userId=Guid.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateTask;
        var userId = authState.User.Claims.FirstOrDefault()?.Value;
        if (userId != null) _userId = Guid.Parse(userId);
    }


    private async Task SubscribeTo()
    {

        if (_lesson.IsUserRegistered(_userId))
        {
            _snackbar.Add("You are already registered", severity: Severity.Error);
            return;
        }

        await _lessons.SubscribeToLesson(_lesson.Id, _userId);
        
        _snackbar.Add("You succesfully regiterd to this lesson", severity: Severity.Success);
        await OnSubscribe.InvokeAsync();
    }
    
    private async Task UnsubscribeFom()
    {

        if (!_lesson.IsUserRegistered(_userId))
        {
            _snackbar.Add("You are not registered", severity: Severity.Error);
            return;
        }

        await _lessons.UnsubscribeFromLesson(_lesson.Id, _userId);
        
        _snackbar.Add("You succesfully unregistered to this lesson", severity: Severity.Success);
        await OnUnSubscribe.InvokeAsync();
    }
    
    
    
}